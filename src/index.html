<!DOCTYPE html>
<html>
<head>
    <style>
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw;
            background: #030007; 
            font-family: sans-serif; 
            overflow: hidden; 
        }
        
        .window { 
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; 
            border: 1px solid #1a1520;
        }
        
        .header { 
            background: #09000b; height: 55px; 
            display: flex; align-items: center; padding: 0 15px; 
            justify-content: space-between; -webkit-app-region: drag; 
            flex-shrink: 0;
        }
        
        .logo-img { height: 42px; width: auto; -webkit-app-region: no-drag; }

        .window-controls { display: flex; -webkit-app-region: no-drag; }
        .control-icon { width: 18px; height: 18px; cursor: pointer; margin-left: 15px; }

        /* The container must be visible for Monaco to render */
        #editor-container { 
            flex: 1; 
            width: 100%; 
            background: #030007; 
            min-height: 100px;
        }

        .footer { 
            background: #09000b; height: 60px; 
            display: flex; align-items: center; padding: 0 15px; 
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .btn-group { display: flex; gap: 8px; }
        .btn { 
            background: #19121c; border: 1px solid #2d2433; 
            width: 42px; height: 42px; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; -webkit-app-region: no-drag;
        }
        .btn img { width: 22px; height: 22px; }

        /* Tab System Styles */
        .tabs-container {
            background: #09000b;
            border-bottom: 1px solid #1a1520;
            display: flex;
            align-items: center;
            gap: 0;
            padding: 8px 10px;
            flex-shrink: 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .tab {
            background: #19121c;
            border: 1px solid #2d2433;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            padding: 8px 12px;
            margin-right: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            -webkit-app-region: no-drag;
            transition: background 0.2s;
        }

        .tab:hover {
            background: #2d2433;
        }

        .tab.active {
            background: #030007;
            border-bottom: 2px solid #030007;
            border-color: #2d2433 #2d2433 #030007 #2d2433;
        }

        .tab-icon {
            width: 16px;
            height: 16px;
        }

        .tab-title {
            font-size: 13px;
            color: #b0a8b8;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            width: 16px;
            height: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            transition: background 0.2s;
        }

        .tab-close:hover {
            background: #3d3340;
        }

        .tab-add {
            background: #19121c;
            border: 1px solid #2d2433;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-app-region: no-drag;
            transition: background 0.2s;
        }

        .tab-add:hover {
            background: #2d2433;
        }

        .tab-add img {
            width: 18px;
            height: 18px;
        }

        /* Settings Modal */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(3, 0, 7, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-panel {
            background: #09000b;
            border: 1px solid #2d2433;
            border-radius: 12px;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #2d2433;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 18px;
            font-weight: bold;
            color: #e0d8e8;
        }

        .settings-close {
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .settings-close:hover {
            background: #2d2433;
        }

        .settings-body {
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 24px;
        }

        .setting-label {
            font-size: 14px;
            color: #b0a8b8;
            margin-bottom: 10px;
            display: block;
        }

        .setting-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .setting-option {
            background: #19121c;
            border: 2px solid #2d2433;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            color: #b0a8b8;
            font-size: 13px;
            transition: all 0.2s;
        }

        .setting-option:hover {
            border-color: #4d4354;
        }

        .setting-option.active {
            border-color: #8b7a99;
            background: #2d2433;
            color: #e0d8e8;
        }

        .theme-preview {
            width: 80px;
            height: 50px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            min-width: 90px;
        }



        .empty-accounts {
            text-align: center;
            color: #888;
            padding: 40px;
            font-size: 16px;
        }

        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .status-message.success {
            background: #1f4d1f;
            border: 1px solid #2f6d2f;
            color: #7fff7f;
        }

        .status-message.error {
            background: #4d1f1f;
            border: 1px solid #6d2f2f;
            color: #ff7f7f;
        }

        .status-message.visible {
            display: block;
        }
    </style>
</head>
<body>

<div class="window">
    <div class="header">
        <img src="Assets/icons/newlogo.png" class="logo-img"> 
        <div class="window-controls">
            <img src="Assets/icons/icons8-minimize-40.png" class="control-icon" onclick="ipcRenderer.send('min')">
            <img src="Assets/icons/icons8-maximize-40.png" class="control-icon" onclick="ipcRenderer.send('max')">
            <img src="Assets/icons/icons8-close-40.png" class="control-icon" onclick="ipcRenderer.send('close')">
        </div>
    </div>

    <div class="tabs-container" id="tabsContainer">
        <div class="tab active" data-tab-id="0" onclick="switchTab(0)">
            <img src="Assets/icons/icons8-script-40.png" class="tab-icon">
            <span class="tab-title">untitled</span>
            <div class="tab-close" onclick="closeTab(0, event)">
                <img src="Assets/icons/icons8-close-18.png" style="width: 12px; height: 12px;">
            </div>
        </div>
        <div class="tab-add" onclick="addNewTab()">
            <img src="Assets/icons/icons8-add-40.png">
        </div>
    </div>

    <div id="editor-container"></div>

    <div class="footer">
        <div class="btn-group">
            <div class="btn" id="executeBtn"><img src="Assets/icons/icons8-play-40_002520(1).png"></div>
            <div class="btn" onclick="window.editor.setValue('')"><img src="Assets/icons/icons8-erase-40.png"></div>
            <div class="btn" onclick="document.getElementById('fileInput').click()"><img src="Assets/icons/icons8-open-file-40_002520(1).png"></div>
            <div class="btn" id="saveBtn"><img src="Assets/icons/icons8-save-40.png"></div>
        </div>
        <div class="btn"><img src="Assets/icons/icons8-attach-40.png"></div>
    </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".lua,.txt">

<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
        <div class="settings-header">
            <span class="settings-title">Settings</span>
            <div class="settings-close" onclick="closeSettings()">
                <img src="Assets/icons/icons8-close-18.png" style="width: 18px; height: 18px;">
            </div>
        </div>
        <div class="settings-body">
            <!-- Theme Setting -->
            <div class="setting-group">
                <label class="setting-label">Theme</label>
                <div class="setting-options">
                    <div class="setting-option theme-option active" onclick="changeTheme('dark')" data-theme="dark">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #030007 0%, #19121c 100%);"></div>
                        <span>Dark</span>
                    </div>
                    <div class="setting-option theme-option" onclick="changeTheme('midnight')" data-theme="midnight">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);"></div>
                        <span>Midnight</span>
                    </div>
                    <div class="setting-option theme-option" onclick="changeTheme('ocean')" data-theme="ocean">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);"></div>
                        <span>Ocean</span>
                    </div>
                    <div class="setting-option theme-option" onclick="changeTheme('forest')" data-theme="forest">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0d1f12 0%, #1a3320 100%);"></div>
                        <span>Forest</span>
                    </div>
                    <div class="setting-option theme-option" onclick="changeTheme('sunset')" data-theme="sunset">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #2d1b1e 0%, #4a2c31 100%);"></div>
                        <span>Sunset</span>
                    </div>
                </div>
            </div>

            <!-- Executor Setting -->
            <div class="setting-group">
                <label class="setting-label">Executor</label>
                <div class="setting-options">
                    <div class="setting-option active" onclick="changeExecutor('opiumware')" data-executor="opiumware">
                        Opiumware
                    </div>
                    <div class="setting-option" onclick="changeExecutor('macsploit')" data-executor="macsploit">
                        MacSploit
                    </div>
                    <div class="setting-option" onclick="changeExecutor('hydrogen')" data-executor="hydrogen">
                        Hydrogen
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    const { ipcRenderer } = require('electron');
    const path = require('path');

    // Settings Management
    let settings = {
        theme: localStorage.getItem('theme') || 'dark',
        executor: localStorage.getItem('executor') || 'opiumware'
    };

    const themes = {
        dark: { background: '#030007', header: '#09000b', border: '#1a1520', button: '#19121c', buttonBorder: '#2d2433' },
        midnight: { background: '#0a0e27', header: '#151a35', border: '#1f2540', button: '#1f2540', buttonBorder: '#2a3050' },
        ocean: { background: '#001f3f', header: '#002d52', border: '#003d5c', button: '#003d5c', buttonBorder: '#004d6d' },
        forest: { background: '#0d1f12', header: '#18301e', border: '#1a3320', button: '#1a3320', buttonBorder: '#234d2a' },
        sunset: { background: '#2d1b1e', header: '#3d262a', border: '#4a2c31', button: '#4a2c31', buttonBorder: '#5a3c41' }
    };

    function openSettings() {
        document.getElementById('settingsOverlay').classList.add('active');
        // Update active states
        document.querySelectorAll('[data-theme]').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === settings.theme);
        });
        document.querySelectorAll('[data-executor]').forEach(el => {
            el.classList.toggle('active', el.dataset.executor === settings.executor);
        });
    }

    function closeSettings() {
        document.getElementById('settingsOverlay').classList.remove('active');
    }

    function changeTheme(themeName) {
        settings.theme = themeName;
        localStorage.setItem('theme', themeName);
        
        const theme = themes[themeName];
        document.body.style.background = theme.background;
        document.querySelector('.window').style.background = theme.background;
        document.getElementById('editor-container').style.background = theme.background;
        document.querySelectorAll('.header, .footer, .tabs-container').forEach(el => {
            el.style.background = theme.header;
        });
        document.querySelector('.window').style.borderColor = theme.border;
        
        // Update button and tab colors
        document.querySelectorAll('.btn, .tab, .tab-add').forEach(el => {
            el.style.background = theme.button;
            el.style.borderColor = theme.buttonBorder;
        });
        
        // Update active tab
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
            activeTab.style.background = theme.background;
        }
        
        // Update Monaco editor background
        if (window.editor) {
            monaco.editor.defineTheme('solaraTheme', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': theme.background,
                }
            });
            monaco.editor.setTheme('solaraTheme');
        }

        // Update active state
        document.querySelectorAll('[data-theme]').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === themeName);
        });
    }

    function changeExecutor(executorName) {
        settings.executor = executorName;
        localStorage.setItem('executor', executorName);
        
        document.querySelectorAll('[data-executor]').forEach(el => {
            el.classList.toggle('active', el.dataset.executor === executorName);
        });
    }

    // Keyboard shortcuts - only handle non-editor shortcuts
    document.addEventListener('keydown', (e) => {
        // Only handle shortcuts when NOT focused in the editor
        const isEditorFocused = document.querySelector('#editor-container').contains(document.activeElement);
        
        // ESC to close settings (works everywhere)
        if (e.key === 'Escape') {
            closeSettings();
        }
        
        // Cmd+Shift+S for Settings (doesn't conflict with Cmd+S save or Cmd+V paste)
        if (!isEditorFocused && (e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            openSettings();
        }
    });

    // Tab Management System
    let tabs = {
        0: { id: 0, title: 'untitled', content: '-- Solara V3\nprint("Solara V3")' }
    };
    let nextTabId = 1;
    let activeTabId = 0;

    function addNewTab() {
        const id = nextTabId++;
        tabs[id] = { 
            id: id, 
            title: `untitled-${id}`, 
            content: '' 
        };

        const tabsContainer = document.getElementById('tabsContainer');
        const newTab = document.createElement('div');
        const currentTheme = themes[settings.theme];
        newTab.className = 'tab';
        newTab.setAttribute('data-tab-id', id);
        newTab.style.background = currentTheme.button;
        newTab.style.borderColor = currentTheme.buttonBorder;
        newTab.innerHTML = `
            <img src="Assets/icons/icons8-script-40.png" class="tab-icon">
            <span class="tab-title">${tabs[id].title}</span>
            <div class="tab-close" onclick="closeTab(${id}, event)">
                <img src="Assets/icons/icons8-close-18.png" style="width: 12px; height: 12px;">
            </div>
        `;
        newTab.onclick = () => switchTab(id);

        // Insert before the add button
        tabsContainer.insertBefore(newTab, document.querySelector('.tab-add'));
        
        switchTab(id);
    }

    function switchTab(id) {
        // Save current tab content
        if (window.editor) {
            tabs[activeTabId].content = window.editor.getValue();
        }

        // Update active tab UI
        const currentTheme = themes[settings.theme];
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
            tab.style.background = currentTheme.button;
        });
        const newTab = document.querySelector(`[data-tab-id="${id}"]`);
        newTab.classList.add('active');
        newTab.style.background = currentTheme.background;

        activeTabId = id;

        // Load new tab content
        if (window.editor) {
            window.editor.setValue(tabs[id].content);
        }
    }

    function closeTab(id, event) {
        event.stopPropagation();
        
        // Don't allow closing if it's the only tab
        if (Object.keys(tabs).length === 1) {
            alert('Cannot close the last tab');
            return;
        }

        delete tabs[id];
        document.querySelector(`[data-tab-id="${id}"]`).remove();

        // If we closed the active tab, switch to another
        if (activeTabId === id) {
            const remainingTabId = Object.keys(tabs)[0];
            switchTab(parseInt(remainingTabId));
        }
    }

    // Use LOCAL node_modules to ensure it never disappears
    const amdLoader = require('./node_modules/monaco-editor/min/vs/loader.js');
    const amdRequire = amdLoader.require;

    amdRequire.config({
        baseUrl: path.join(__dirname, './node_modules/monaco-editor/min')
    });

    // Apply saved theme before Monaco loads
    const currentTheme = themes[settings.theme];
    document.body.style.background = currentTheme.background;
    document.querySelector('.window').style.background = currentTheme.background;
    document.getElementById('editor-container').style.background = currentTheme.background;
    document.querySelectorAll('.header, .footer, .tabs-container').forEach(el => {
        el.style.background = currentTheme.header;
    });
    document.querySelector('.window').style.borderColor = currentTheme.border;
    
    // Update button and tab colors on load
    document.querySelectorAll('.btn, .tab, .tab-add').forEach(el => {
        el.style.background = currentTheme.button;
        el.style.borderColor = currentTheme.buttonBorder;
    });
    
    // Update active tab
    const activeTab = document.querySelector('.tab.active');
    if (activeTab) {
        activeTab.style.background = currentTheme.background;
    }

    amdRequire(['vs/editor/editor.main'], function() {
        monaco.editor.defineTheme('solaraTheme', {
            base: 'vs-dark',
            inherit: true,
            rules: [],
            colors: {
                'editor.background': currentTheme.background,
            }
        });

        window.editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: tabs[0].content,
            language: 'lua',
            theme: 'solaraTheme',
            automaticLayout: false,
            minimap: { enabled: false },
            contextmenu: true,
            quickSuggestions: true,
            wordWrap: 'on'
        });

        // Manual resize handling (debounced to prevent freezing)
        let resizeTimeout;
        const resizeObserver = new ResizeObserver(() => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (window.editor) {
                    window.editor.layout();
                }
            }, 100);
        });
        resizeObserver.observe(document.getElementById('editor-container'));
    });

    // Forced layout refresh when Maximize is clicked
    ipcRenderer.on('resize-editor', () => {
        if(window.editor) window.editor.layout();
    });

    // Save Logic
    document.getElementById('saveBtn').onclick = () => {
        const content = window.editor.getValue();
        const blob = new Blob([content], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${tabs[activeTabId].title}.lua`;
        a.click();
    };

    // Execute Button Logic
    document.getElementById('executeBtn').onclick = async () => {
        const code = window.editor.getValue();
        try {
            const result = await ipcRenderer.invoke('execute', code, 'ALL', settings.executor);
            console.log(`Execute result (${settings.executor}):`, result);
        } catch (err) {
            console.error('Execute error:', err);
        }
    };


</script>
</body>

</html>
